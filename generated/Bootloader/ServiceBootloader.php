<?php

declare(strict_types=1);

namespace GRPC\Bootloader;

use GRPC\Admin\AdminGrpcClient;
use GRPC\Admin\AdminGrpcInterface;
use GRPC\Config\GRPCServicesConfig;
use GRPC\User\UserGrpcClient;
use GRPC\User\UserGrpcInterface;
use GRPC\category\CategoryGrpcClient;
use GRPC\category\CategoryGrpcInterface;
use GRPC\product\ProductGrpcClient;
use GRPC\product\ProductGrpcInterface;
use Spiral\Boot\Bootloader\Bootloader;
use Spiral\Boot\EnvironmentInterface;
use Spiral\Config\ConfiguratorInterface;
use Spiral\Core\Container;
use Spiral\Core\InterceptableCore;
use Spiral\RoadRunnerBridge\GRPC\Interceptor\ServiceClientCore;

class ServiceBootloader extends Bootloader
{
    public function __construct(
        private readonly ConfiguratorInterface $config,
    ) {
    }

    public function init(EnvironmentInterface $env): void
    {
        $this->initConfig($env);
    }

    public function boot(Container $container): void
    {
        $this->initServices($container);
    }

    /**
     * Don't edit this method manually, it is generated by GRPC services generator.
     */
    private function initConfig(EnvironmentInterface $env): void
    {
        $this->config->setDefaults(
            GRPCServicesConfig::CONFIG,
            [
                'services' => [
                    UserGrpcClient::class => ['host' => $env->get('USER_GRPC_HOST', '127.0.0.1:9000')],
                    CategoryGrpcClient::class => ['host' => $env->get('CATEGORY_GRPC_HOST', '127.0.0.1:9001')],
                    ProductGrpcClient::class => ['host' => $env->get('PRODUCT_GRPC_HOST', '127.0.0.1:9002')],
                    UserGrpcClient::class => ['host' => $env->get('USER_GRPC_HOST', '127.0.0.1:9003')],
                    CategoryGrpcClient::class => ['host' => $env->get('CATEGORY_GRPC_HOST', '127.0.0.1:9004')],
                    ProductGrpcClient::class => ['host' => $env->get('PRODUCT_GRPC_HOST', '127.0.0.1:9005')],
                    UserGrpcClient::class => ['host' => $env->get('USER_GRPC_HOST', '127.0.0.1:9006')],
                    CategoryGrpcClient::class => ['host' => $env->get('CATEGORY_GRPC_HOST', '127.0.0.1:9007')],
                    ProductGrpcClient::class => ['host' => $env->get('PRODUCT_GRPC_HOST', '127.0.0.1:9008')],
                ],
            ]
        );
    }

    /**
     * Don't edit this method manually, it is generated by GRPC services generator.
     */
    private function initServices(Container $container): void
    {
        $container->bindSingleton(
            UserGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): UserGrpcInterface
            {
                $service = $config->getService(UserGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(UserGrpcClient::class, ['core' => $core]);
            }
        );
        $container->bindSingleton(
            CategoryGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): CategoryGrpcInterface
            {
                $service = $config->getService(CategoryGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(CategoryGrpcClient::class, ['core' => $core]);
            }
        );
        $container->bindSingleton(
            ProductGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): ProductGrpcInterface
            {
                $service = $config->getService(ProductGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(ProductGrpcClient::class, ['core' => $core]);
            }
        );
        $container->bindSingleton(
            UserGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): UserGrpcInterface
            {
                $service = $config->getService(UserGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(UserGrpcClient::class, ['core' => $core]);
            }
        );
        $container->bindSingleton(
            CategoryGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): CategoryGrpcInterface
            {
                $service = $config->getService(CategoryGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(CategoryGrpcClient::class, ['core' => $core]);
            }
        );
        $container->bindSingleton(
            ProductGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): ProductGrpcInterface
            {
                $service = $config->getService(ProductGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(ProductGrpcClient::class, ['core' => $core]);
            }
        );
        $container->bindSingleton(
            UserGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): UserGrpcInterface
            {
                $service = $config->getService(UserGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(UserGrpcClient::class, ['core' => $core]);
            }
        );
        $container->bindSingleton(
            CategoryGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): CategoryGrpcInterface
            {
                $service = $config->getService(CategoryGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(CategoryGrpcClient::class, ['core' => $core]);
            }
        );
        $container->bindSingleton(
            ProductGrpcInterface::class,
            static function(GRPCServicesConfig $config) use($container): ProductGrpcInterface
            {
                $service = $config->getService(ProductGrpcClient::class);
                $core = new InterceptableCore(new ServiceClientCore(
                    $service['host'],
                    ['credentials' => $service['credentials'] ?? $config->getDefaultCredentials()]
                ));

                foreach ($config->getInterceptors() as $interceptor) {
                    $core->addInterceptor($container->get($interceptor));
                }

                return $container->make(ProductGrpcClient::class, ['core' => $core]);
            }
        );
    }
}
